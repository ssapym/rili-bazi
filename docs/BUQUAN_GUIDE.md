# 八字补全功能说明

## 概述

八字补全功能是基于已有的四柱八字，根据拱夹暗带关系推导出新的干支，补充到八字中的功能。该功能可以帮助命理师更全面地分析八字，发现隐藏的命理信息。

## 功能说明

### 补全类型

八字补全功能包含三种补全类型：

#### 1. 拱三合

**定义**：天干相同的两柱，地支形成三合局的一部分，推导出第三个地支

**三合局**：
- 申子辰三合水：如果有申和辰，推导出子
- 亥卯未三合木：如果有亥和未，推导出卯
- 寅午戌三合火：如果有寅和戌，推导出午
- 巳酉丑三合金：如果有巳和丑，推导出酉

**前提条件**：
- 两柱天干相同
- 两柱地支形成三合局的一部分
- 推导出的地支不在原八字中

**示例**：
```
八字：甲申 甲辰 乙卯 丙午
分析：年柱（甲申）和月柱（甲申）天干相同，地支申和辰形成三合局的一部分
推导：申子辰三合水局，推导出子
结果：八字补全后包含子
```

#### 2. 拱隔位（夹）

**定义**：天干相同的两柱，地支隔位相夹，推导出被夹的地支

**夹关系**：
- 子寅夹丑：子和寅中间夹着丑
- 丑卯夹寅：丑和卯中间夹着寅
- 寅辰夹卯：寅和辰中间夹着卯
- 卯巳夹辰：卯和巳中间夹着辰
- 辰午夹巳：辰和午中间夹着巳
- 巳未夹午：巳和未中间夹着午
- 午申夹未：午和申中间夹着未
- 未酉夹申：未和酉中间夹着申
- 申戌夹酉：申和戌中间夹着酉
- 酉亥夹戌：酉和亥中间夹着戌
- 戌子夹亥：戌和子中间夹着亥
- 亥丑夹子：亥和丑中间夹着子

**前提条件**：
- 两柱天干相同
- 两柱地支在十二地支顺序中相邻
- 推导出的地支不在原八字中

**示例**：
```
八字：甲子 甲寅 乙卯 丙午
分析：年柱（甲子）和月柱（甲寅）天干相同，地支子和寅在十二地支顺序中相邻
推导：子和寅中间夹着丑
结果：八字补全后包含丑
```

#### 3. 暗带

**定义**：相邻的两柱干支在同一个六旬内，且在六旬表中隔位相夹，推导出中间的干支

**六旬表**：
- 甲子旬：甲子、乙丑、丙寅、丁卯、戊辰、己巳、庚午、辛未、壬申、癸酉
- 甲戌旬：甲戌、乙亥、丙子、丁丑、戊寅、己卯、庚辰、辛巳、壬午、癸未
- 甲申旬：甲申、乙酉、丙戌、丁亥、戊子、己丑、庚寅、辛卯、壬辰、癸巳
- 甲午旬：甲午、乙未、丙申、丁酉、戊戌、己亥、庚子、辛丑、壬寅、癸卯
- 甲辰旬：甲辰、乙巳、丙午、丁未、戊申、己酉、庚戌、辛亥、壬子、癸丑
- 甲寅旬：甲寅、乙卯、丙辰、丁巳、戊午、己未、庚申、辛酉、壬戌、癸亥

**前提条件**：
- 两柱必须相邻（年-月、月-日、日-时）
- 两柱的干支必须在同一个六旬内
- 在六旬表中的位置隔一个（索引差为2）

**示例**：
```
八字：甲子 丙寅 乙卯 丙午
分析：年柱（甲子）和月柱（丙寅）相邻，都在甲子旬内，位置分别为第1个和第3个
推导：第1个和第3个中间夹着第2个（乙丑）
结果：暗带乙丑
```

```
八字：甲辰 辛亥 癸丑 乙卯
分析：月柱（辛亥）和日柱（癸丑）相邻，都在甲辰旬内，位置分别为第8个和第10个
推导：第8个和第10个中间夹着第9个（壬子）
结果：暗带壬子
```

**反例**：
```
八字：癸巳 乙未 丙申 丁酉
分析：癸巳（甲申旬第10个）和乙未（甲午旬第2个）不在同一旬
结果：不算暗带
```

```
八字：甲子 乙丑 丙寅 丁卯
分析：年柱（甲子）和时柱（丁卯）不相邻
结果：不算暗带
```

## 冲突检测

### 概述

八字补全功能包含冲突检测机制，用于检测推导出的干支与原八字中所有柱（包括有效暗带推导出的柱）之间的冲突关系。

### 冲突类型

#### 1. 地支六冲

**适用范围**：拱三合和拱隔位（夹）

**定义**：推导出的地支与原八字中某柱的地支形成六冲关系

**六冲关系**：
- 子午冲：子与午相冲
- 丑未冲：丑与未相冲
- 寅申冲：寅与申相冲
- 卯酉冲：卯与酉相冲
- 辰戌冲：辰与戌相冲
- 巳亥冲：巳与亥相冲

**示例**：
```
八字：甲子 甲午 乙卯 丙午
拱三合：推导出子
冲突检测：子与午相冲（年柱和时柱）
结果：标记冲突
```

#### 2. 双冲

**适用范围**：暗带

**定义**：推导出的干支与原八字中某柱的干支同时形成天干相冲和地支相冲

**双冲关系**：共60组，天干相冲（10组）× 地支相冲（6组）

**示例**：
```
八字：甲子 乙丑 丙寅 丁卯
暗带：推导出甲午
冲突检测：甲午与甲子双冲（天干相同不冲，地支子午冲）
结果：不标记冲突（天干不冲）
```

```
八字：甲子 乙丑 丙寅 丁卯
暗带：推导出庚午
冲突检测：庚午与甲子双冲（天干甲庚冲，地支子午冲）
结果：标记冲突
```

#### 3. 天克地刑（自刑）

**适用范围**：暗带

**定义**：推导出的干支与原八字中某柱的干支同时形成天干相克和地支自刑

**天克地刑关系**：共20组

**地支自刑**：
- 辰辰自刑：辰与辰自刑
- 午午自刑：午与午自刑
- 亥亥自刑：亥与亥自刑
- 酉酉自刑：酉与酉自刑

**示例**：
```
八字：乙亥 乙丑 丙寅 丁卯
暗带：推导出己亥
冲突检测：己亥与乙亥天克地刑（天干乙己克，地支亥亥自刑）
结果：标记冲突
```

### 计算优先级

八字补全功能按照以下优先级计算：

1. **优先计算暗带**
   - 计算所有暗带关系
   - 检测每个暗带推导出的干支是否有双冲或天克地刑冲突
   - 如果有冲突，标记冲突但不参与后续计算
   - 如果没有冲突，将该暗带推导出的干支加入临时柱列表

2. **计算拱三合和拱隔位**
   - 基于原八字四柱 + 有效暗带推导出的柱进行计算
   - 检测每个推导出的地支是否有地支六冲冲突
   - 标记所有冲突

### 冲突输出格式

每个补全结果都会包含冲突信息：

```json
{
  "source": "年+月",
  "desc": "申辰拱合子",
  "derivedBranch": "子",
  "conflicts": [
    {
      "type": "地支六冲",
      "desc": "子与午相冲",
      "targetPillar": "年",
      "targetBranch": "午"
    }
  ]
}
```

**字段说明**：
- `type`: 冲突类型（地支六冲、双冲、天克地刑）
- `desc`: 冲突描述
- `targetPillar`: 目标柱位置（年、月、日、时）
- `targetBranch`: 目标地支（地支六冲）或目标干支（双冲、天克地刑）
- `targetGanZhi`: 目标干支（双冲、天克地刑）

### 示例

#### 示例 1：拱三合有地支六冲

**八字**：甲子 甲午 乙卯 丙午

**拱三合**：
- 年柱（甲子）和时柱（甲午）天干相同
- 地支子和午不形成三合局，无拱三合

**结果**：无拱三合

#### 示例 2：暗带有双冲

**八字**：甲子 乙丑 丙寅 丁卯

**暗带**：
- 年柱（甲子）和月柱（乙丑）相邻，在甲子旬内
- 位置分别为第1个和第2个，不满足隔位条件
- 无暗带

**结果**：无暗带

#### 示例 3：暗带有天克地刑

**八字**：乙亥 乙丑 丙寅 丁卯

**暗带**：
- 年柱（乙亥）和月柱（乙丑）相邻，在甲子旬内
- 位置分别为第2个和第2个，不满足隔位条件
- 无暗带

**结果**：无暗带

### 注意事项

1. **冲突不影响输出**：不管是否有冲突，JSON输出都会包含所有补全结果，只是标记冲突信息

2. **有效暗带参与计算**：没有冲突的暗带推导出的干支会参与后续的拱三合和拱隔位计算

3. **多冲突检测**：一个补全结果可能与多个柱产生冲突，会记录所有冲突

4. **冲突类型互斥**：同一对干支不会同时标记为双冲和天克地刑

## API 接口

### 请求参数

八字补全功能集成在主 API 接口中，无需额外请求参数。

**接口地址**：`GET /api/bazi`

**请求参数**：
- `year`: 年份（如：1997）
- `month`: 月份（如：4）
- `day`: 日期（如：11）
- `hour`: 小时（如：10）
- `gender`: 性别（1=男，2=女）
- `longitude`: 经度（可选，默认：116.42，北京东城）

### 响应数据

八字补全功能返回的数据结构：

```json
{
  "success": true,
  "data": {
    "buquan": {
      "derivedBranches": ["子", "丑", "卯"],
      "gongsanhe": [
        {
          "source": "年+月",
          "desc": "申辰拱合子",
          "type": "合",
          "derivedBranch": "子",
          "derivedIndex": 0,
          "conflicts": []
        }
      ],
      "gonggewei": [
        {
          "source": "月+日",
          "desc": "子寅夹丑",
          "type": "夹",
          "derivedBranch": "丑",
          "derivedIndex": 1,
          "conflicts": []
        }
      ],
      "andai": [
        {
          "source": "年+月",
          "desc": "甲子丙寅暗带乙丑",
          "derivedStem": "乙",
          "derivedBranch": "丑",
          "derivedGanZhi": "乙丑",
          "xun": "甲子旬",
          "index1": 0,
          "index2": 2,
          "middleIndex": 1,
          "conflicts": []
        }
      ],
      "summary": {
        "totalDerived": 3,
        "gongsanheCount": 1,
        "gonggeweiCount": 2,
        "andaiCount": 1
      }
    }
  }
}
```

### 字段说明

#### buquan.derivedBranches

**类型**：数组

**说明**：所有推导出的地支列表（去重）

**示例**：`["子", "丑", "卯"]`

#### buquan.gongsanhe

**类型**：数组

**说明**：拱三合推导出的地支详细信息

**字段**：
- `source`: 源柱位置（如："年+月"）
- `desc`: 关系描述（如："申辰拱合子"）
- `type`: 关系类型（如："合"）
- `derivedBranch`: 推导出的地支（如："子"）
- `derivedIndex`: 推导出的地支索引（如：0）
- `conflicts`: 冲突信息数组（如有冲突）

#### buquan.gonggewei

**类型**：数组

**说明**：拱隔位（夹）推导出的地支详细信息

**字段**：
- `source`: 源柱位置（如："月+日"）
- `desc`: 关系描述（如："子寅夹丑"）
- `type`: 关系类型（如："夹"）
- `derivedBranch`: 推导出的地支（如："丑"）
- `derivedIndex`: 推导出的地支索引（如：1）
- `conflicts`: 冲突信息数组（如有冲突）

#### buquan.andai

**类型**：数组

**说明**：暗带推导出的干支详细信息

**字段**：
- `source`: 源柱位置（如："年+月"）
- `desc`: 关系描述（如："甲子丙寅暗带乙丑"）
- `derivedStem`: 推导出的天干（如："乙"）
- `derivedBranch`: 推导出的地支（如："丑"）
- `derivedGanZhi`: 推导出的干支（如："乙丑"）
- `xun`: 所属六旬（如："甲子旬"）
- `index1`: 第一个干支在六旬中的索引（如：0）
- `index2`: 第二个干支在六旬中的索引（如：2）
- `middleIndex`: 中间干支在六旬中的索引（如：1）
- `conflicts`: 冲突信息数组（如有冲突）

#### conflicts 字段说明

**类型**：数组

**说明**：冲突信息数组，每个元素代表一个冲突

**字段**：
- `type`: 冲突类型（地支六冲、双冲、天克地刑）
- `desc`: 冲突描述（如："子与午相冲"）
- `targetPillar`: 目标柱位置（年、月、日、时）
- `targetBranch`: 目标地支（地支六冲）或目标干支（双冲、天克地刑）
- `targetGanZhi`: 目标干支（双冲、天克地刑）

#### buquan.summary

**类型**：对象

**说明**：八字补全的统计信息

**字段**：
- `totalDerived`: 推导出的地支总数
- `gongsanheCount`: 拱三合推导出的地支数量
- `gonggeweiCount`: 拱隔位（夹）推导出的地支数量
- `andaiCount`: 暗带推导出的干支数量

## 使用示例

### 示例 1：拱三合

**请求**：
```bash
curl "http://localhost:8000/api/bazi?year=1997&month=4&day=11&hour=10&gender=2"
```

**响应**：
```json
{
  "success": true,
  "data": {
    "buquan": {
      "derivedBranches": ["子"],
      "gongsanhe": [
        {
          "source": "年+月",
          "desc": "申辰拱合子",
          "type": "合",
          "derivedBranch": "子",
          "derivedIndex": 0
        }
      ],
      "gonggewei": [],
      "summary": {
        "totalDerived": 1,
        "gongsanheCount": 1,
        "gonggeweiCount": 0
      }
    }
  }
}
```

**说明**：
- 年柱（甲申）和月柱（甲辰）天干相同
- 地支申和辰形成三合局的一部分
- 推导出子
- 八字补全后包含子

### 示例 2：拱隔位（夹）

**请求**：
```bash
curl "http://localhost:8000/api/bazi?year=1985&month=6&day=15&hour=14&gender=1"
```

**响应**：
```json
{
  "success": true,
  "data": {
    "buquan": {
      "derivedBranches": ["丑"],
      "gongsanhe": [],
      "gonggewei": [
        {
          "source": "年+月",
          "desc": "子寅夹丑",
          "type": "夹",
          "derivedBranch": "丑",
          "derivedIndex": 1
        }
      ],
      "summary": {
        "totalDerived": 1,
        "gongsanheCount": 0,
        "gonggeweiCount": 1
      }
    }
  }
}
```

**说明**：
- 年柱（甲子）和月柱（甲寅）天干相同
- 地支子和寅在十二地支顺序中相邻
- 推导出丑
- 八字补全后包含丑

### 示例 3：同时有拱三合和拱隔位

**请求**：
```bash
curl "http://localhost:8000/api/bazi?year=1978&month=11&day=28&hour=16&gender=1"
```

**响应**：
```json
{
  "success": true,
  "data": {
    "buquan": {
      "derivedBranches": ["子", "丑"],
      "gongsanhe": [
        {
          "source": "月+时",
          "desc": "申辰拱合子",
          "type": "合",
          "derivedBranch": "子",
          "derivedIndex": 0
        }
      ],
      "gonggewei": [
        {
          "source": "年+日",
          "desc": "子寅夹丑",
          "type": "夹",
          "derivedBranch": "丑",
          "derivedIndex": 1
        }
      ],
      "summary": {
        "totalDerived": 2,
        "gongsanheCount": 1,
        "gonggeweiCount": 1
      }
    }
  }
}
```

**说明**：
- 月柱（甲申）和时柱（甲辰）天干相同，地支申和辰形成三合局的一部分，推导出子
- 年柱（甲子）和日柱（甲寅）天干相同，地支子和寅在十二地支顺序中相邻，推导出丑
- 八字补全后包含子和丑

### 示例 4：暗带

**请求**：
```bash
curl "http://localhost:8000/api/bazi?year=1984&month=2&day=15&hour=9&gender=1"
```

**响应**：
```json
{
  "success": true,
  "data": {
    "buquan": {
      "derivedBranches": ["丑"],
      "gongsanhe": [],
      "gonggewei": [],
      "andai": [
        {
          "source": "年+月",
          "desc": "甲子丙寅暗带乙丑",
          "derivedStem": "乙",
          "derivedBranch": "丑",
          "derivedGanZhi": "乙丑",
          "xun": "甲子旬",
          "index1": 0,
          "index2": 2,
          "middleIndex": 1
        }
      ],
      "summary": {
        "totalDerived": 1,
        "gongsanheCount": 0,
        "gonggeweiCount": 0,
        "andaiCount": 1
      }
    }
  }
}
```

**说明**：
- 年柱（甲子）和月柱（丙寅）相邻
- 两柱都在甲子旬内，位置分别为第1个和第3个
- 推导：第1个和第3个中间夹着第2个（乙丑）
- 八字补全后包含乙丑

### 示例 5：同时有拱三合和暗带

**请求**：
```bash
curl "http://localhost:8000/api/bazi?year=1990&month=1&day=15&hour=6&gender=2"
```

**响应**：
```json
{
  "success": true,
  "data": {
    "buquan": {
      "derivedBranches": ["丑", "辰"],
      "gongsanhe": [],
      "gonggewei": [
        {
          "source": "年+时",
          "desc": "卯巳夹辰",
          "type": "夹",
          "derivedBranch": "辰",
          "derivedIndex": 4
        }
      ],
      "andai": [],
      "summary": {
        "totalDerived": 1,
        "gongsanheCount": 0,
        "gonggeweiCount": 1,
        "andaiCount": 0
      }
    }
  }
}
```

**说明**：
- 年柱（己巳）和时柱（己卯）天干相同，地支巳和卯在十二地支顺序中相邻
- 推导：巳和卯中间夹着辰
- 八字补全后包含辰

## 注意事项

1. **前提条件**：八字补全的前提条件是两柱天干相同，如果八字中没有天干相同的两柱，则无法进行补全

2. **去重处理**：推导出的地支会进行去重处理，避免重复添加

3. **与原八字的关系**：推导出的地支是补充信息，不改变原八字的结构，只是提供额外的命理分析角度

4. **与其他功能的关系**：八字补全功能是独立的，与五行能量、十神分布、神煞等功能配合使用，可以提供更全面的命理分析

## 测试

### 运行测试

八字补全功能已集成到统一测试入口，使用以下命令测试：

```bash
cd test
node index.js buquan
```

### 测试内容

八字补全冲突检测测试会验证以下内容：
1. buquan 数据结构是否正确
2. derivedBranches 是否为数组
3. gongsanhe 是否为数组
4. gonggewei 是否为数组
5. andai 是否为数组
6. summary 是否包含正确的统计信息
7. 每个推导出的地支信息是否包含完整的字段
8. 每个推导出的干支信息是否包含完整的字段
9. 冲突检测是否正确
10. conflicts 字段格式是否正确

### 测试选项

八字补全冲突检测测试支持所有标准测试选项：

```bash
# 测试所有预设用例
node index.js buquan

# 测试前3个预设用例
node index.js buquan -p 3

# 测试单个指定生日
node index.js buquan -s 1984-3-15-10-男

# 测试5个随机用例
node index.js buquan -r 5

# 组合使用
node index.js buquan -p 3 -r 5 -s 1984-3-15-10-男
```

### 测试输出

测试会显示每个测试用例的详细信息：
- 补全地支列表
- 拱三合、拱隔位、暗带数量
- 每个补全结果的详细信息
- 冲突检测结果（如有）

## 更新记录

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2026-01-27 | v1.0 | 初始版本，实现拱三合和拱隔位（夹）功能 |
| 2026-01-28 | v1.1 | 新增暗带功能，支持相邻两柱在六旬内隔位相夹推导 |
| 2026-01-28 | v1.2 | 修复buquan.summary.totalDerived未包含暗带计数的问题 |
| 2026-01-30 | v1.3 | 新增冲突检测功能：暗带检测双冲和天克地刑，拱三合和拱隔位检测地支六冲；实现优先计算顺序，有效暗带参与后续计算；统一冲突输出格式；新增buquan测试类型到统一测试入口 |

## 技术实现

### 核心文件

- `/server/src/services/buquanService.js`: 八字补全服务
- `/server/src/services/relationshipService.js`: 关系定义和工具函数
- `/server/src/services/baziService.js`: 主服务（集成八字补全功能）

### 代码复用

八字补全服务复用了 relationshipService.js 中的以下内容：

- **常量定义**：
  - `STEMS`: 天干数组
  - `BRANCHES`: 地支数组
  - `GX`: 地支关系定义数组（包含拱隔位定义）
  - `PILLAR_NAMES`: 柱名称数组

- **工具函数**：
  - `array_intersect()`: 数组交集
  - `array_diff()`: 数组差集
  - `empty()`: 空值判断
  - `count()`: 计数
  - `getRelationType()`: 获取关系类型

### 主要函数

- `calculateBuQuan(pillars)`: 计算八字补全
  - 输入：四柱八字信息
  - 输出：推导出的地支信息

### 关系定义

在 `relationshipService.js` 中定义了 type=14 的拱隔位（夹）关系：

```javascript
[1, 14, [0, 2], 1, '子寅夹丑'],
[1, 14, [1, 3], 2, '丑卯夹寅'],
// ... 其他夹关系
```

### 类型映射

在 `relationshipService.js` 的 `getRelationType` 函数中，type=14 映射为 '夹'：

```javascript
const types = {
  // ... 其他类型
  14: '夹'
};
```

## 常见问题

### Q1: 八字补全功能会改变原八字吗？

A: 不会。八字补全功能只是基于原八字推导出额外的地支信息，不改变原八字的结构。

### Q2: 推导出的地支有什么用？

A: 推导出的地支可以帮助命理师从更多角度分析八字，发现隐藏的命理信息，提供更全面的命理分析。

### Q3: 如果八字中没有天干相同的两柱怎么办？

A: 如果八字中没有天干相同的两柱，则无法进行补全，buquan.derivedBranches 会是空数组。

### Q4: 拱三合和拱隔位可以同时存在吗？

A: 可以。一个八字中可能同时存在拱三合和拱隔位，两者会分别推导出不同的地支。

### Q5: 推导出的地支会重复吗？

A: 不会。系统会对推导出的地支进行去重处理，确保每个地支只出现一次。
